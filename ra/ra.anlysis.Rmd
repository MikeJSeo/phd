---
title: "ra analysis"
author: "Michael Seo"
date: "1 Februar 2020"
output: html_document
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(tidy = TRUE, tidy.opts=list(blank=FALSE, width.cutoff=60), warning = FALSE, message=FALSE)
```

```{r}
library("readxl")
library("mixmeta") #previously mvmeta
library("rjags")

setwd("C:/Users/ms19g661/Desktop")
#setwd("C:/Users/mike/Desktop")

# xls files
mydata <- read_excel("ra_dataset.xlsx")
mydata <- as.data.frame(mydata)

setwd("~/GitHub/phd/ra")
#setwd("C:/Users/mike/Desktop/Github/phd/ra")


## data with non-missing outcome
mydata <- mydata[!is.na(mydata$change_das_bsr),]
#apply(mydata, 2, function(x) sum(is.na(x)))

## data with complete data: three covariates removed
data <- mydata[, -which(colnames(mydata) %in% c("base_bmi", "base_haq", "comorbidities"))]
data <- data[complete.cases(data),]

## variables to include
# gender
# age
## not included: base_bmi: BMI
# disease_duration: time from RA diagnosis to baseline visit, in years
# n_prev_dmards: No. of previous cDMARDs
# n_prev_antiTNF: No. of previous anti-TNF agents
# base_rf : rheumatoid factor
# conc_stero: On steroids
## not included: base_haq: HAQ questionnaire (another disease activity score)
## not included: comorbidities
# base_bsr: baseline ESR, not to be confused with the DAS28
# base_das_bsr: baseline DAS28 score

## four studies; BSRBR, REFLEX, SCQM, TOWARD

# BSRBR

BSRBR <- data[data$study == "BSRBR",]
table(BSRBR$treatment)

# REFLEX

REFLEX <- data[data$study == "REFLEX",]
table(REFLEX$treatment)

# SCQM

SCQM <- data[data$study == "SCQM",]
table(SCQM$treatment)

# TOWARD

TOWARD <- data[data$study == "TOWARD",]
table(TOWARD$treatment)
```

## First stage analysis: BSRBR

Here's how treatment is assigned.

"DMARDs" is assigned 1 (baseline); "RTX + DMARDs" is assigned 2 (second column); "TCZ + DMARDs" is assigned 3 (third column)

```{r BSRBR, cache = TRUE}
data <- BSRBR
y <- data$change_das_bsr
X <- data[,c("gender", "age", "disease_duration", "n_prev_dmards", "n_prev_antiTNF", "base_rf", "conc_stero", "base_bsr", "base_das_bsr")]
Np <- length(y)
Ncovariate <- ncol(X)

data$treatment[data$treatment == "DMARDs"] <- 1
data$treatment[data$treatment == "RTX + DMARDs"] <- 2
data$treatment[data$treatment == "TCZ + DMARDs"] <- 3
data$treatment <- as.numeric(data$treatment)

Ntreat <- length(unique(data$treatment))

data_jags <- with(data,{
  list(y = y,
       X = X,
       Np = Np,
       Ncovariate = Ncovariate,
       treat = treatment,
       Ntreat = Ntreat)
})

jags_model <- jags.model("IPD-MA.txt", data_jags, n.chains = 3, n.adapt = 1000)
BSRBR_samples <- coda.samples(jags_model, variable.names = c("alpha","gamma", "beta", "delta"), n.iter = 10000)
summary(BSRBR_samples)
```

## First stage analysis: SCQM

```{r SCQM, cache = TRUE}
data <- SCQM
y <- data$change_das_bsr
X <- data[,c("gender", "age", "disease_duration", "n_prev_dmards", "n_prev_antiTNF", "base_rf", "conc_stero", "base_bsr", "base_das_bsr")]
Np <- length(y)
Ncovariate <- ncol(X)

data$treatment[data$treatment == "DMARDs"] <- 1
data$treatment[data$treatment == "RTX + DMARDs"] <- 2
data$treatment[data$treatment == "TCZ + DMARDs"] <- 3
data$treatment <- as.numeric(data$treatment)

Ntreat <- length(unique(data$treatment))

data_jags <- with(data,{
  list(y = y,
       X = X,
       Np = Np,
       Ncovariate = Ncovariate,
       treat = treatment,
       Ntreat = Ntreat)
})

jags_model <- jags.model("IPD-MA.txt", data_jags, n.chains = 3, n.adapt = 1000)
SCQM_samples <- coda.samples(jags_model, variable.names = c("alpha", "gamma", "beta", "delta"), n.iter = 10000)
summary(SCQM_samples)
```

## First stage analysis: REFLEX

This one doesn't have TCZ + DMARDs

"DMARDs" is assigned 1 (baseline); "RTX + DMARDs" is assigned 2 (second column)

```{r REFLEX, cache = TRUE}
data <- REFLEX
y <- data$change_das_bsr
X <- data[,c("gender", "age", "disease_duration", "n_prev_dmards", "n_prev_antiTNF", "base_rf", "conc_stero", "base_bsr", "base_das_bsr")]
Np <- length(y)
Ncovariate <- ncol(X)

data$treatment[data$treatment == "DMARDs"] <- 1
data$treatment[data$treatment == "RTX + DMARDs"] <- 2
data$treatment <- as.numeric(data$treatment)
Ntreat <- length(unique(data$treatment))

data_jags <- with(data,{
  list(y = y,
       X = X,
       Np = Np,
       Ncovariate = Ncovariate,
       treat = treatment,
       Ntreat = Ntreat
       )
})

jags_model <- jags.model("IPD-MA.txt", data_jags, n.chains = 3, n.adapt = 1000)
REFLEX_samples <- coda.samples(jags_model, variable.names = c("alpha", "gamma", "beta", "delta"), n.iter = 10000)
summary(REFLEX_samples)
```


## First stage analysis: TOWARD

This one doesn't have RTX + DMARDs

"DMARDs" is assigned 1 (baseline); "TCZ + DMARDs" is assigned 2 (second column)


```{r TOWARD, cache = TRUE}
data <- TOWARD
y <- data$change_das_bsr
X <- data[,c("gender", "age", "disease_duration", "n_prev_dmards", "n_prev_antiTNF", "base_rf", "conc_stero", "base_bsr", "base_das_bsr")]
Np <- length(y)
Ncovariate <- ncol(X)

data$treatment[data$treatment == "DMARDs"] <- 1
data$treatment[data$treatment == "TCZ + DMARDs"] <- 2
data$treatment <- as.numeric(data$treatment)
Ntreat <- length(unique(data$treatment))

data_jags <- with(data,{
  list(y = y,
       X = X,
       Np = Np,
       Ncovariate = Ncovariate,
       treat = treatment,
       Ntreat = Ntreat)
})

jags_model <- jags.model("IPD-MA.txt", data_jags, n.chains = 3, n.adapt = 1000)
TOWARD_samples <- coda.samples(jags_model, variable.names = c("alpha","gamma", "beta", "delta"), n.iter = 10000)
summary(TOWARD_samples)
```


## Second stage:

Train 2 RCT + Swiss then externally validate using British registry.
calculate mu which consists of 9 covariates, 2 treatment effect, 18 effect modifiers = vector of 29. 

```{r}
#names_of_vector <- colnames(BSRBR_samples)

#SCQM
SCQM_result <- as.matrix(SCQM_samples)
SCQM_result <- SCQM_result[, colSums(SCQM_result != 0) > 0] #remove 0 columns

y1 <- apply(SCQM_result, 2, mean)
Omega1 <- solve(cov(SCQM_result))


#REFLEX
REFLEX_result <- as.matrix(REFLEX_samples)
REFLEX_result <- REFLEX_result[, colSums(REFLEX_result != 0) > 0] #remove 0 columns

y2 <- apply(REFLEX_result, 2, mean)
Omega2 <- solve(cov(REFLEX_result))

###TOWARD
TOWARD_result <- as.matrix(TOWARD_samples)
TOWARD_result <- TOWARD_result[, colSums(TOWARD_result != 0) > 0] #remove 0 columns

y3 <- apply(TOWARD_result, 2, mean)
Omega3 <- solve(cov(TOWARD_result))


data_jags2 <- 
  list(y1 = y1,
       y2 = y2, 
       y3 = y3,
       Omega1 = Omega1,
       Omega2 = Omega2,
       Omega3 = Omega3,
       Ncovariate = Ncovariate,
       R = diag(10),
       k = 10)

jags_model2 <- jags.model("IPD-MA-stage2.txt", data_jags2, n.chains = 3, n.adapt = 1000)
samples <- coda.samples(jags_model2, variable.names = c("alpha","beta", "gamma2", "gamma3", "delta2", "delta3"), n.iter = 10000)




#BSRBR
BSRBR_result <- as.matrix(BSRBR_samples)
BSRBR_result <- BSRBR_result[, colSums(BSRBR_result != 0) > 0] #remove 0 columns

y1 <- apply(BSRBR_result, 2, mean)
Omega1 <- solve(cov(BSRBR_result))







REFLEX_mean <- summary(REFLEX_samples)$statistics[,1]
REFLEX_se <- summary(REFLEX_samples)$statistics[,2] / dim(REFLEX)[1]

SCQM_mean <- summary(SCQM_samples)$statistics[,1]
SCQM_se <- summary(SCQM_samples)$statistics[,2] / dim(SCQM)[1]


#beta
y <- rbind(BSRBR_mean[1:Ncovariate], SCQM_mean[1:Ncovariate], REFLEX_mean[1:Ncovariate], TOWARD_mean[1:Ncovariate])
se <- rbind(BSRBR_se[1:Ncovariate], SCQM_se[1:Ncovariate], REFLEX_se[1:Ncovariate], TOWARD_se[1:Ncovariate])
colnames(y) <- colnames(X)
y

beta_estimate <- rep(NA, Ncovariate)
for(i in 1:Ncovariate){
 dd <- data.frame(y = y[,i], se = se[,i])
 beta_estimate[i] <- mixmeta(y ~ 1, S = se^2, dd, method = "reml")$coefficients
}
names(beta_estimate) <- colnames(X)
beta_estimate
  
# RTX + DMARDs treatment effect
y <- rbind(BSRBR_mean[c("delta[2]")], SCQM_mean[c("delta[2]")], REFLEX_mean[c("delta[2]")])
se <- rbind(BSRBR_se[c("delta[2]")], SCQM_se[c("delta[2]")], REFLEX_se[c("delta[2]")])
y

dd <- data.frame(y = y, se = se)
RTX_estimate <- mixmeta(y ~ 1, S = se^2, dd, method = "reml")$coefficients
names(RTX_estimate) <- "RTX"
RTX_estimate

# TCZ + DMARDs
y <- rbind(BSRBR_mean[c("delta[3]")], SCQM_mean[c("delta[3]")], TOWARD_mean[c("delta[2]")])
se <- rbind(BSRBR_se[c("delta[3]")], SCQM_se[c("delta[3]")], TOWARD_se[c("delta[2]")])
y

dd <- data.frame(y = y, se = se)
TCZ_estimate <- mixmeta(y ~ 1, S = se^2, dd, method = "reml")$coefficients
names(TCZ_estimate) <- "TCZ"
TCZ_estimate

# gamma RTX x treatment
gamma.names <- names(BSRBR_mean)[grepl("gamma", names(BSRBR_mean))][-c(1:Ncovariate)]

y <- rbind(BSRBR_mean[gamma.names[1:Ncovariate]], SCQM_mean[gamma.names[1:Ncovariate]], REFLEX_mean[gamma.names[1:Ncovariate]])
colnames(y) <- colnames(X)
y # (SCQM, BSRBR) vs REFLEX 

se <- rbind(BSRBR_se[gamma.names[1:Ncovariate]], SCQM_se[gamma.names[1:Ncovariate]], REFLEX_se[gamma.names[1:Ncovariate]])

gammaRTX_estimate <- rep(NA, Ncovariate)
for(i in 1:Ncovariate){
 dd <- data.frame(y = y[,i], se = se[,i])
 gammaRTX_estimate[i] <- mixmeta(y ~ 1, S = se^2, dd, method = "reml")$coefficients
}
names(gammaRTX_estimate) <- colnames(X)
gammaRTX_estimate

# gamma TCZ x treatment
y <- rbind(BSRBR_mean[gamma.names[(Ncovariate+1):(2*Ncovariate)]], SCQM_mean[gamma.names[(Ncovariate+1):(2*Ncovariate)]], TOWARD_mean[gamma.names[1:Ncovariate]])
colnames(y) <- colnames(X)
y # (SCQM, BSRBR) vs TOWARD

se <- rbind(BSRBR_se[gamma.names[(Ncovariate+1):(2*Ncovariate)]], SCQM_se[gamma.names[(Ncovariate+1):(2*Ncovariate)]], TOWARD_se[gamma.names[1:Ncovariate]])

gammaTCZ_estimate <- rep(NA, Ncovariate)
for(i in 1:Ncovariate){
 dd <- data.frame(y = y[,i], se = se[,i])
 gammaTCZ_estimate[i] <- mixmeta(y ~ 1, S = se^2, dd, method = "reml")$coefficients
}
names(gammaTCZ_estimate) <- colnames(X)
gammaTCZ_estimate
```

## JAGS code

```{r}
jags_model #model code
```