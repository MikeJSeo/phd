---
title: "ra analysis"
author: "Michael Seo"
date: "1 February 2020"
output: html_document
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(tidy = TRUE, tidy.opts=list(blank=FALSE, width.cutoff=60), warning = FALSE, message=FALSE)
```

```{r}
library("readxl")
#library("mixmeta") #previously mvmeta
library("rjags")
library("caret") # for 10 fold cross-validation

#setwd("C:/Users/ms19g661/Desktop")
setwd("C:/Users/mike/Desktop")

# xls files
mydata <- read_excel("ra_dataset.xlsx")
mydata <- as.data.frame(mydata)

#setwd("~/GitHub/phd/ra")
setwd("C:/Users/mike/Desktop/Github/phd/ra")


## data with non-missing outcome
mydata <- mydata[!is.na(mydata$change_das_bsr),]
#apply(mydata, 2, function(x) sum(is.na(x)))

## data with complete data: three covariates removed
data <- mydata[, -which(colnames(mydata) %in% c("base_bmi", "base_haq", "comorbidities"))]
data <- data[complete.cases(data),]

## variables to include
# gender
# age
## not included: base_bmi: BMI
# disease_duration: time from RA diagnosis to baseline visit, in years
# n_prev_dmards: No. of previous cDMARDs
# n_prev_antiTNF: No. of previous anti-TNF agents
# base_rf : rheumatoid factor
# conc_stero: On steroids
## not included: base_haq: HAQ questionnaire (another disease activity score)
## not included: comorbidities
# base_bsr: baseline ESR, not to be confused with the DAS28
# base_das_bsr: baseline DAS28 score

## four studies; BSRBR, REFLEX, SCQM, TOWARD

# BSRBR

BSRBR <- data[data$study == "BSRBR",]
table(BSRBR$treatment)

# REFLEX

REFLEX <- data[data$study == "REFLEX",]
table(REFLEX$treatment)

# SCQM

SCQM <- data[data$study == "SCQM",]
table(SCQM$treatment)

# TOWARD

TOWARD <- data[data$study == "TOWARD",]
table(TOWARD$treatment)
```


## First stage analysis: REFLEX

This one doesn't have TCZ + DMARDs

"DMARDs" is assigned 1 (baseline); "RTX + DMARDs" is assigned 2 (second column)

```{r REFLEX, cache = TRUE}
data <- REFLEX
y <- data$change_das_bsr
X <- data[,c("gender", "age", "disease_duration", "n_prev_dmards", "n_prev_antiTNF", "base_rf", "conc_stero", "base_bsr", "base_das_bsr")]
Np <- length(y)
Ncovariate <- ncol(X)

data$treatment[data$treatment == "DMARDs"] <- 1
data$treatment[data$treatment == "RTX + DMARDs"] <- 2
data$treatment <- as.numeric(data$treatment)
Ntreat <- length(unique(data$treatment))

data_jags <- with(data,{
  list(y = y,
       X = X,
       Np = Np,
       Ncovariate = Ncovariate,
       treat = treatment,
       Ntreat = Ntreat
       )
})

jags_model <- jags.model("IPD-MA.txt", data_jags, n.chains = 3, n.adapt = 1000)
REFLEX_samples <- coda.samples(jags_model, variable.names = c("alpha", "gamma", "beta", "delta"), n.iter = 10000)
summary(REFLEX_samples)
```


## First stage analysis: TOWARD

This one doesn't have RTX + DMARDs

"DMARDs" is assigned 1 (baseline); "TCZ + DMARDs" is assigned 2 (second column)


```{r TOWARD, cache = TRUE}
data <- TOWARD
y <- data$change_das_bsr
X <- data[,c("gender", "age", "disease_duration", "n_prev_dmards", "n_prev_antiTNF", "base_rf", "conc_stero", "base_bsr", "base_das_bsr")]
Np <- length(y)
Ncovariate <- ncol(X)

data$treatment[data$treatment == "DMARDs"] <- 1
data$treatment[data$treatment == "TCZ + DMARDs"] <- 2
data$treatment <- as.numeric(data$treatment)
Ntreat <- length(unique(data$treatment))

data_jags <- with(data,{
  list(y = y,
       X = X,
       Np = Np,
       Ncovariate = Ncovariate,
       treat = treatment,
       Ntreat = Ntreat)
})

jags_model <- jags.model("IPD-MA.txt", data_jags, n.chains = 3, n.adapt = 1000)
TOWARD_samples <- coda.samples(jags_model, variable.names = c("alpha","gamma", "beta", "delta"), n.iter = 10000)
summary(TOWARD_samples)
```



## Internal cross-validation with SCQM

```{r SCQM, cache = TRUE}
full_colnames <- c("alpha", colnames(X),  "RTX", "TCZ", paste(colnames(X), "* RTX"), paste(colnames(X), "* TCZ"))
partial_colnames1 <- c("alpha", colnames(X), "RTX", paste(colnames(X), "* RTX"))
partial_colnames2 <- c("alpha", colnames(X), "TCZ", paste(colnames(X), "* TCZ"))

data <- SCQM
data$treatment[data$treatment == "DMARDs"] <- 1
data$treatment[data$treatment == "RTX + DMARDs"] <- 2
data$treatment[data$treatment == "TCZ + DMARDs"] <- 3
data$treatment <- as.numeric(data$treatment)
Ntreat <- length(unique(data$treatment))

folds <- createFolds(seq(nrow(data)), k = 10)

cv_store <- rep(NA, 10)
cv_store2 <- rep(NA, 10)

for(i in 1:10){
  
  test_indexes <- folds[[i]]
  test <- data[testIndexes,]
  train <- data[-testIndexes,]
  
  y <- train$change_das_bsr
  X <- train[,c("gender", "age", "disease_duration", "n_prev_dmards", "n_prev_antiTNF", "base_rf", "conc_stero", "base_bsr", "base_das_bsr")]
  Np <- length(y)
  Ncovariate <- ncol(X)
  
  data_jags <- with(train,{
  list(y = y,
       X = X,
       Np = Np,
       Ncovariate = Ncovariate,
       treat = treatment,
       Ntreat = Ntreat)
  })
  
  jags_model <- jags.model("IPD-MA.txt", data_jags, n.chains = 3, n.adapt = 1000)
  SCQM_samples <- coda.samples(jags_model, variable.names = c("alpha", "gamma", "beta", "delta"), n.iter = 10000)
  
  ### stage 2
  #SCQM
  SCQM_result <- as.matrix(SCQM_samples)
  SCQM_result <- SCQM_result[, colSums(SCQM_result != 0) > 0] #remove 0 columns

  y1 <- apply(SCQM_result, 2, mean); names(y1) <- full_colnames
  Sigma1 <- cov(SCQM_result); colnames(Sigma1) <- rownames(Sigma1) <- full_colnames

  y1_treat <- y1[c("RTX", "TCZ")]
  Sigma1_treat <- Sigma1[c("RTX", "TCZ"), c("RTX", "TCZ")]
  Omega1_treat <- solve(Sigma1_treat)

  y1_notreat <- y1[!names(y1) %in% c("RTX", "TCZ")]
  Sigma1_notreat <- Sigma1[!names(y1) %in% c("RTX", "TCZ"), !names(y1) %in% c("RTX", "TCZ")]
  Omega1_notreat <- solve(Sigma1_notreat)

  #REFLEX
  REFLEX_result <- as.matrix(REFLEX_samples)
  REFLEX_result <- REFLEX_result[, colSums(REFLEX_result != 0) > 0] #remove 0 columns

  y2 <- apply(REFLEX_result, 2, mean); names(y2) <- partial_colnames1
  Sigma2 <- cov(REFLEX_result); colnames(Sigma2) <- rownames(Sigma2) <- partial_colnames1

  y2_treat <- y2["RTX"]
  Sigma2_treat <- Sigma2["RTX", "RTX"]
  Omega2_treat <- solve(Sigma2_treat) #just an inverse i.e. precision

  y2_notreat <- y2[!names(y2) %in% c("RTX")]
  Sigma2_notreat <- Sigma2[!names(y2) %in% c("RTX"), !names(y2) %in% c("RTX")]
  Omega2_notreat <- solve(Sigma2_notreat)

  #TOWARD
  TOWARD_result <- as.matrix(TOWARD_samples)
  TOWARD_result <- TOWARD_result[, colSums(TOWARD_result != 0) > 0] #remove 0 columns

  y3 <- apply(TOWARD_result, 2, mean); names(y3) <- partial_colnames2
  Sigma3 <- cov(TOWARD_result); colnames(Sigma3) <- rownames(Sigma3) <- partial_colnames2

  y3_treat <- y3["TCZ"]
  Sigma3_treat <- Sigma3["TCZ", "TCZ"]
  Omega3_treat <- solve(Sigma3_treat)

  y3_notreat <- y3[!names(y3) %in% c("TCZ")]
  Sigma3_notreat <- Sigma3[!names(y3) %in% c("TCZ"), !names(y3) %in% c("TCZ")]
  Omega3_notreat <- solve(Sigma3_notreat)


  # meta analyze treatment effect
  data_jags2 <- 
    list(y1 = y1_treat,
         y2 = y2_treat, 
         y3 = y3_treat,
         Omega1 = Omega1_treat,
         Omega2 = Omega2_treat,
        Omega3 = Omega3_treat)

  jags_model2 <- jags.model("IPD-MA-stage2.txt", data_jags2, n.chains = 3, n.adapt = 1000)
  samples2 <- coda.samples(jags_model2, variable.names = c("delta", "Sigma", "sigma1", "sigma2"), n.iter = 10000)


  # meta analyzing other paraameters assuming no correlations (i.e. univariate)
  data_jags3 <- 
    list(y1 = y1_notreat,
         y2 = y2_notreat, 
         y3 = y3_notreat,
        Omega1 = Omega1_notreat,
        Omega2 = Omega2_notreat,
        Omega3 = Omega3_notreat,
        ncovariate = 9)

  jags_model3 <- jags.model("IPD-MA-stage2-notreat.txt", data_jags3, n.chains = 3, n.adapt = 1000)
  samples3 <- coda.samples(jags_model3, variable.names = c("alpha", "beta", "gamma2", "gamma3"), n.iter = 10000)
  
  # get a vector alpha, beta, 
  y_test <- test$change_das_bsr
  X_test <- test[,c("gender", "age", "disease_duration", "n_prev_dmards", "n_prev_antiTNF", "base_rf", "conc_stero", "base_bsr", "base_das_bsr")]

  #add in all the linear terms
  prediction <- summary(samples2)[[1]]["delta[1]", "Mean"] * ifelse(test$treatment == 2, 1, 0) + summary(samples2)[[1]]["delta[2]", "Mean"] * ifelse(test$treatment == 3, 1, 0)  
  
  prediction <- prediction + summary(samples3)[[1]]["alpha", "Mean"] 
  
  dummy <- summary(samples3)[[1]]
  prediction <- prediction + as.matrix(X_test) %*% dummy[grep("beta", rownames(dummy)),"Mean"]
    
  prediction <- prediction + as.matrix(X_test) %*% dummy[grep("gamma2", rownames(dummy)),"Mean"] * ifelse(test$treatment == 2, 1, 0) + as.matrix(X_test) %*% dummy[grep("gamma3", rownames(dummy)),"Mean"] * ifelse(test$treatment == 3, 1, 0)  
    
  cv_store[i] <- mean((y_test - prediction)^2)
  
  
  # using only SCQM
  prediction2 <- summary(SCQM_samples)[[1]]["delta[2]", "Mean"] * ifelse(test$treatment == 2, 1, 0) + summary(SCQM_samples)[[1]]["delta[3]", "Mean"] * ifelse(test$treatment == 3, 1, 0)
  
  prediction2 <- prediction2 + summary(SCQM_samples)[[1]]["alpha", "Mean"]
  
  dummy <- summary(SCQM_samples)[[1]]
  prediction2 <- prediction2 + as.matrix(X_test) %*% dummy[grep("beta", rownames(dummy)),"Mean"]
    
  gamma2_index <- grep("gamma", rownames(dummy))[1:Ncovariate]
  gamma3_index <- grep("gamma", rownames(dummy))[(Ncovariate+1):(2*Ncovariate)]
  prediction2 <- prediction2 + as.matrix(X_test) %*% dummy[gamma2_index,"Mean"] * ifelse(test$treatment == 2, 1, 0) + as.matrix(X_test) %*% dummy[gamma3_index,"Mean"] * ifelse(test$treatment == 3, 1, 0)  
    
  cv_store2[i] <- mean((y_test - prediction2)^2)
  
  
}

```


## Second stage

## Bayesian approach

Train 2 RCT + Swiss then externally validate using British registry.
Calculate mu which consists of 1 study intercept, 9 covariates, 2 treatment effect, 18 effect modifiers = vector of 30.

```{r}
full_colnames <- c("alpha", colnames(X),  "RTX", "TCZ", paste(colnames(X), "* RTX"), paste(colnames(X), "* TCZ"))
partial_colnames1 <- c("alpha", colnames(X), "RTX", paste(colnames(X), "* RTX"))
partial_colnames2 <- c("alpha", colnames(X), "TCZ", paste(colnames(X), "* TCZ"))

#SCQM
SCQM_result <- as.matrix(SCQM_samples)
SCQM_result <- SCQM_result[, colSums(SCQM_result != 0) > 0] #remove 0 columns

y1 <- apply(SCQM_result, 2, mean); names(y1) <- full_colnames
Sigma1 <- cov(SCQM_result); colnames(Sigma1) <- rownames(Sigma1) <- full_colnames

y1_treat <- y1[c("RTX", "TCZ")]
Sigma1_treat <- Sigma1[c("RTX", "TCZ"), c("RTX", "TCZ")]
Omega1_treat <- solve(Sigma1_treat)

y1_notreat <- y1[!names(y1) %in% c("RTX", "TCZ")]
Sigma1_notreat <- Sigma1[!names(y1) %in% c("RTX", "TCZ"), !names(y1) %in% c("RTX", "TCZ")]
Omega1_notreat <- solve(Sigma1_notreat)

#REFLEX
REFLEX_result <- as.matrix(REFLEX_samples)
REFLEX_result <- REFLEX_result[, colSums(REFLEX_result != 0) > 0] #remove 0 columns

y2 <- apply(REFLEX_result, 2, mean); names(y2) <- partial_colnames1
Sigma2 <- cov(REFLEX_result); colnames(Sigma2) <- rownames(Sigma2) <- partial_colnames1

y2_treat <- y2["RTX"]
Sigma2_treat <- Sigma2["RTX", "RTX"]
Omega2_treat <- solve(Sigma2_treat) #just an inverse i.e. precision

y2_notreat <- y2[!names(y2) %in% c("RTX")]
Sigma2_notreat <- Sigma2[!names(y2) %in% c("RTX"), !names(y2) %in% c("RTX")]
Omega2_notreat <- solve(Sigma2_notreat)

###TOWARD
TOWARD_result <- as.matrix(TOWARD_samples)
TOWARD_result <- TOWARD_result[, colSums(TOWARD_result != 0) > 0] #remove 0 columns

y3 <- apply(TOWARD_result, 2, mean); names(y3) <- partial_colnames2
Sigma3 <- cov(TOWARD_result); colnames(Sigma3) <- rownames(Sigma3) <- partial_colnames2

y3_treat <- y3["TCZ"]
Sigma3_treat <- Sigma3["TCZ", "TCZ"]
Omega3_treat <- solve(Sigma3_treat)

y3_notreat <- y3[!names(y3) %in% c("TCZ")]
Sigma3_notreat <- Sigma3[!names(y3) %in% c("TCZ"), !names(y3) %in% c("TCZ")]
Omega3_notreat <- solve(Sigma3_notreat)


# meta analyze treatment effect
data_jags2 <- 
  list(y1 = y1_treat,
       y2 = y2_treat, 
       y3 = y3_treat,
       Omega1 = Omega1_treat,
       Omega2 = Omega2_treat,
       Omega3 = Omega3_treat)

jags_model2 <- jags.model("IPD-MA-stage2.txt", data_jags2, n.chains = 3, n.adapt = 1000)
samples <- coda.samples(jags_model2, variable.names = c("delta", "Sigma", "sigma1", "sigma2"), n.iter = 10000)


# meta analyzing other paraameters assuming no correlations (i.e. univariate)
data_jags3 <- 
  list(y1 = y1_notreat,
       y2 = y2_notreat, 
       y3 = y3_notreat,
       Omega1 = Omega1_notreat,
       Omega2 = Omega2_notreat,
       Omega3 = Omega3_notreat,
       ncovariate = 9
       )

jags_model3 <- jags.model("IPD-MA-stage2-notreat.txt", data_jags3, n.chains = 3, n.adapt = 1000)
samples <- coda.samples(jags_model3, variable.names = c("alpha", "beta","delta", "gamma2", "gamma3"), n.iter = 10000)
```




## External validation with BSRBR


Here's how treatment is assigned.

"DMARDs" is assigned 1 (baseline); "RTX + DMARDs" is assigned 2 (second column); "TCZ + DMARDs" is assigned 3 (third column)

```{r BSRBR, cache = TRUE}
data <- BSRBR
y <- data$change_das_bsr
X <- data[,c("gender", "age", "disease_duration", "n_prev_dmards", "n_prev_antiTNF", "base_rf", "conc_stero", "base_bsr", "base_das_bsr")]
Np <- length(y)
Ncovariate <- ncol(X)

data$treatment[data$treatment == "DMARDs"] <- 1
data$treatment[data$treatment == "RTX + DMARDs"] <- 2
data$treatment[data$treatment == "TCZ + DMARDs"] <- 3
data$treatment <- as.numeric(data$treatment)

Ntreat <- length(unique(data$treatment))

data_jags <- with(data,{
  list(y = y,
       X = X,
       Np = Np,
       Ncovariate = Ncovariate,
       treat = treatment,
       Ntreat = Ntreat)
})

jags_model <- jags.model("IPD-MA.txt", data_jags, n.chains = 3, n.adapt = 1000)
BSRBR_samples <- coda.samples(jags_model, variable.names = c("alpha","gamma", "beta", "delta"), n.iter = 10000)
summary(BSRBR_samples)
```



## JAGS code

```{r}
jags_model #model code
```