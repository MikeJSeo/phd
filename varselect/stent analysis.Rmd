---
title: "Variable selection in individual patient data meta-analysis - stent dataset"
author: "Michael Seo"
date: "5 August 2019"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(tidy = TRUE, tidy.opts=list(blank=FALSE, width.cutoff=60), warning = FALSE, message=FALSE, echo = FALSE)
```


```{r}
# load packages needed
library(readstata13)

library(lme4) #for fitting glmm
library(glmnet) #for lasso
library(glmmLasso) #for glmmLasso
library(dclone) # for parllel processing of JAGS code

source("helpful.functions.R")
```


```{r}
# Setting directory
setwd("C:/Users/ms19g661/Desktop")
#setwd("C:/Users/mike/Desktop")
#stent <- read.dta13("stent.dta")
stent <- read.dta13("1_year_stent_data_21092018.dta")

#load/save everything else from/to github
setwd("~/GitHub/phd/varselect")
#setwd("C:/Users/mike/Desktop/Github/phd/varselect")
```


```{r Stent_data_processing}
# "age", "gender", "diabetes", "stable_cad", "multivessel","ladtreated", "overlap", "m_dia_above_3", "gpi", "new_p2y12", "num_stent"
# dropped gpi, new_p2y12
# dropped study 19: too big
study_inclusion <- c(3, 4, 5, 12, 13, 14, 15, 17)
data0 <- stent[stent$trial_name %in% study_inclusion,]

#rename study
for(i in 1:dim(data0)[1]){
  data0$trial_name[i] <- which(data0$trial_name[i] == study_inclusion)
}
data0$trial_name <- as.factor(data0$trial_name)

X <-  data0[,c("age", "gender", "diabetes", "stable_cad", "multivessel","ladtreated", "overlap", "m_dia_above_3", "num_stent")]

#standardized numerical variables
X["age"] <- lapply(X["age"], scale)

#recode categorical variables
ii <- sapply(X, is.factor)
X[ii] <- lapply(X[ii], as.character)
X[X == "Yes"] <- 1
X[X == "Male"] <- 1
X[X == "No"] <- 0
X[X == "Female"] <- 0
X[ii] <- lapply(X[ii], as.numeric)

data_stent <- cbind(X, y = data0$a_death_5yr_yn, treat = ifelse(data0$rand == "BMS", 0, 1), studyid = data0$trial_name)
mydata <- na.omit(data_stent)

X <- mydata[,c("age", "gender", "diabetes", "stable_cad", "multivessel","ladtreated", "overlap", "m_dia_above_3", "num_stent")]

# Total data: 11433 -> complete cases X: 11106 

data_jags_stent <- with(mydata, {
        list(Nstudies = length(unique(studyid)),
        num.continuous = 1,
        num.discrete = 7,
        num.count = 1,
        Ncovariate = 9,
        X = X,
        Np = dim(X)[1],
        studyid = studyid,
        treat = treat + 1,
        y = y)})

col_labels_stent <- c("age", "gender", "diabetes", "stable_cad", "multivessel", "ladtreated", "overlap", "m_dia_above_3", "num_stent")
col_labels_stent_all <- c("(Intercept)", col_labels_stent, paste0(col_labels_stent, ":treat"), "treat", paste0("as.factor(studyid)", 1:length(unique(mydata$studyid))))
col_labels_stent_glmm <- c("(Intercept)", col_labels_stent, paste0(col_labels_stent, "_treat"), "treat", paste0("as.factor(studyid)", 1:length(unique(mydata$studyid))))

# matrix to store results
stent_coef <- matrix(NA, nrow = length(col_labels_stent_all), ncol = 8)
rownames(stent_coef) <- col_labels_stent_all
colnames(stent_coef) <- c("simple null","simple lm", "naive step", "naive lasso", "glmmLasso", "bayes lasso","SSVS", "SSVS Ind")

stent_sd <- matrix(NA, nrow = length(col_labels_stent_all), ncol = 7)
rownames(stent_sd) <- col_labels_stent_all
colnames(stent_sd) <- c("simple null","simple lm", "naive step", "naive lasso", "glmmLasso", "bayes lasso", "SSVS")
```

## glmm_null

```{r glmm_null_stent, cache = TRUE}
m1 <- glmer(y ~ -1 + studyid + treat + (-1 + treat|studyid), data = mydata, family = binomial)
summary(m1)
```

## glmm_full

```{r glmm_full_stent, cache = TRUE}
m2 <- glmer(y ~ -1 + studyid + (age + gender + diabetes + stable_cad + multivessel + ladtreated + overlap + m_dia_above_3 + num_stent)*treat + (-1 + treat|studyid), data = mydata, family = binomial)
summary(m2)
```


```{r simple_model_stent, cache = TRUE, results = "hide", eval = FALSE}
m3 <- glm(y ~ (age + gender + diabetes + stable_cad + multivessel + ladtreated + overlap + m_dia_above_3 + num_stent)*treat, family = binomial(link = "logit"), data = mydata)
summary(m3)
# # ladtreated = 1, num_stents = 5
# contr <- c(rep(0, 6), 0, 0, 0, 0, 0, rep(0, 5), 1, 0, 0, 5)
# v1 <- vcov(m1)
# se1 <- c(sqrt(contr %*% v1 %*% contr))
# exp(c(contr %*% coef(m1)) + qnorm(c(.025,.50,.975))* c(se1))
# 
# # ladtreated = 0, num_stents = 1
# contr <- c(rep(0, 6), 0, 0, 0, 0, 0, rep(0, 5), 0, 0, 0, 1)
# v1 <- vcov(m1)
# se1 <- c(sqrt(contr %*% v1 %*% contr))
# exp(c(contr %*% coef(m1)) + qnorm(c(.025,.50,.975))* c(se1))
```

## naive step

```{r naive_step_stent, cache = TRUE, results = "hide"}
m1 <- glm(y ~ (age + gender + diabetes + stable_cad + multivessel + ladtreated + overlap + m_dia_above_3 + num_stent)*treat, family = binomial(link = "logit"), data = mydata)
s1 <- step(m1, scope=list(upper = ~ (age + gender + diabetes + stable_cad + multivessel + ladtreated + overlap + m_dia_above_3 + num_stent)*treat, lower = ~ treat))
```

```{r}
summary(s1)
```


```{r glmnet_stent, cache = TRUE}
data_glmnet <- model.matrix(y~ -1 + (age + gender + diabetes + stable_cad + multivessel + ladtreated + overlap + m_dia_above_3 + num_stent)*treat, data = mydata)
data_glmnet <- cbind(y = mydata$y, data_glmnet = data_glmnet)

p.fac.stent <- c(rep(1, 9), 0, rep(1,9)) #No shrinkage for treatment effect
cvfit = cv.glmnet(as.matrix(data_glmnet[,-1]), as.matrix(data_glmnet[,1]), penalty.factor = p.fac.stent, family = "binomial", type.measure = "class")
coef(cvfit, s = "lambda.min")
```

```{r glmmLasso_stent, cache = TRUE}
data_glmmLasso <- model.matrix(y~ -1 + (age + gender + diabetes + stable_cad + multivessel + ladtreated + overlap + m_dia_above_3  + num_stent)*treat, data = mydata)
data_glmmLasso <- cbind(y = mydata$y, data_glmmLasso = data_glmmLasso, studyid = mydata$studyid)

colnames(data_glmmLasso) <- gsub(":", "_", colnames(data_glmmLasso))  
data_glmmLasso <- as.data.frame(data_glmmLasso)
data_glmmLasso$studyid <- as.factor(data_glmmLasso$studyid)

form.fixed <- as.formula(y ~ as.factor(studyid) + age +  gender + diabetes + stable_cad + multivessel + ladtreated + overlap + m_dia_above_3 + num_stent + age_treat +  gender_treat + diabetes_treat + stable_cad_treat + multivessel_treat + ladtreated_treat + overlap_treat + m_dia_above_3_treat + num_stent_treat + treat)
form.rnd <- list(studyid =~ -1 + treat)

cv.fit <- cv.glmmLasso(data_glmmLasso, form.fixed = form.fixed, form.rnd = form.rnd, lambda = seq(100, 0,
  by = -5), family = binomial(link = "logit"))
summary(cv.fit)
```


```{r}
# setup for parallel computing
n.cores <- 3
cl <- makePSOCKcluster(n.cores)
tmp <- clusterEvalQ(cl, library(dclone))
```

```{r bayesianLASSO_stent, cache = TRUE, eval = FALSE}
model_bayesLASSO <- jags.parfit(cl = cl, data = data_jags_stent, params = c("alpha","beta","g", "d", "tauDelta"), model = "IPD-MA-bayesLASSO-binomial.txt", n.chains = 3, n.adapt = 100, n.update = 1000, n.iter = 10000)
summary(model_bayesLASSO)
```


```{r SSVS_stent, cache = TRUE, eval = FALSE}
model_SSVS <- jags.parfit(cl = cl, data = data_jags_stent, params = c("alpha","beta","g", "d", "tauDelta", "IndA", "IndA2"), model = "IPD-MA-SSVS-binomial.txt", n.chains = 3, n.adapt = 100, n.update = 1000, n.iter = 10000)
summary(model_SSVS)
```
